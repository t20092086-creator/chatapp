<!-- ওঁ নমো 

সিদ্ধিদাতা গণেশায় নমঃ                        সিদ্ধিদাতা গণেশায় নমঃ                                   সিদ্ধিদাতা গণেশায় নমঃ -->

<!DOCTYPE html>
<html lang="en">

<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7006477250957433"
    crossorigin="anonymous"></script>
  <meta name="google-site-verification" content="lvrePtNXjs6Q-t-SX8DeUld6iPEPqAFfLrUTcY_U2o4" />
  <link rel="icon" href="/icons/favicon.ico" type="image/png">
  <meta charset="utf-8" />
  <link rel="manifest" href="/manifest.json">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, height=device-height" />
  <title>💬 Realtime Chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    html,
    body {
      height: 100%;
      /* Hide scrollbar (cross-browser) */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    html::-webkit-scrollbar {
      display: none;
      /* Chrome, Safari, Opera */
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      /* lock app to viewport */
      overflow: auto;
      /* page itself never scrolls on desktop */
      background: #100e09;
      color: #eaeaea;
      /* Hide scrollbar (cross-browser) */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    /* Landing page wrapper (intro + footer) */
    #intro-wrapper {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      line-height: 1.6;
    }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background: #1a1812;
      padding: 15px;
      border-right: 1px solid #333;
      box-sizing: border-box;
      transition: transform .4s ease-in-out;
      position: relative;
      z-index: 2;
      color: #eaeaea;

      display: flex;
      flex-direction: column;
      height: 100vh;
      /* fixed column height */
    }

    #sidebar.hidden {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      transform: translateX(-100%);
    }

    #sidebar input[type="text"] {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px 2px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      color: #fff;
      background: linear-gradient(145deg, #0d0d0d, #1a1a1a);
      box-shadow: inset 2px 2px 5px rgba(0, 0, 0, .6), inset -2px -2px 5px rgba(50, 50, 50, .6);
      transition: all .3s;
    }

    #sidebar input[type="text"]::placeholder {
      color: #888
    }

    #sidebar input[type="text"]:hover {
      background: linear-gradient(145deg, #1c1c1c, #2a2a2a)
    }

    #sidebar input[type="text"]:focus {
      outline: none;
      background: linear-gradient(145deg, #222, #333);
      box-shadow: 0 0 6px #25d366, inset 2px 2px 6px rgba(0, 0, 0, .7)
    }

    /* Chat container */
    #chat-container {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      background: #100e09;
      min-height: 0;
      /* overflow: hidden; */
      /* allow internal scrollers */
    }

    /* Arrows */
    #show-arrow,
    #toggle-arrow {
      font-size: 18px;
      cursor: pointer;
      background: #256e4c;
      color: #eaeaea;
      padding: 4px 10px;
      border-radius: 4px;
      user-select: none;
      transition: background .3s;
    }

    #toggle-arrow {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 3;
    }

    #show-arrow {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 5;
      display: none;
    }

    #toggle-arrow:hover,
    #show-arrow:hover {
      background: #25d366;
    }

    /* Messages */
    #messages {
      flex: 1 1 0;
      padding: 15px;
      overflow-y: auto;
      background: #100e09;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      min-height: 0;
      overscroll-behavior: contain;
      /* wheel doesn’t bubble to page */
    }

    #messages::-webkit-scrollbar {
      display: none;
    }

    .msg {
      margin: 5px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
      font-size: 14px;
    }

    .msg.me {
      background: #1e3a5f;
      color: #f1f1f1;
      margin-left: auto;
      text-align: right;
    }

    .msg.other {
      background: #2f3d2e;
      color: #f1f1f1;
      margin-right: auto;
      text-align: left;
    }

    .msg.system {
      display: block;
      width: 100% !important;
      max-width: 100% !important;
      text-align: center;
      color: #aaa;
      font-style: italic;
      margin: 10px 0;
      box-sizing: border-box;
    }

    /* Input area */
    #input-area {
      display: flex;
      border-top: 1px solid #333;
      background: #1a1812;
    }

    #input {
      flex: 1;
      padding: 10px;
      border: none;
      font-size: 16px;
      background: #100e09;
      color: #eaeaea;
    }

    #input::placeholder {
      color: #777;
    }

    #attach {
      padding: 10px 15px;
      border: none;
      background: #2c3e50;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }

    #attach:hover {
      background: #34495e;
    }

    #send {
      padding: 10px 20px;
      border: none;
      background: #27ae60;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    #send:hover {
      background: #2ecc71;
    }

    /* Sidebar buttons */
    #sidebar button {
      margin-top: 5px;
      padding: 8px;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
    }

    #sidebar button:hover {
      opacity: .9
    }

    #sidebar button:nth-child(3) {
      background: #e67e22;
      color: #fff;
    }

    #sidebar button:nth-child(4) {
      background: #c0392b;
      color: #fff;
    }

    #sidebar button:nth-child(5) {
      background: #e74c3c;
      color: #fff;
    }

    .username {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .image-wrapper {
      position: relative;
      display: inline-block;
    }

    .image-wrapper img {
      max-width: 220px;
      border-radius: 8px;
      display: block;
    }

    .download-icon {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0, 0, 0, .5);
      padding: 4px;
      border-radius: 4px;
      text-decoration: none;
      color: white;
    }

    .download-icon:hover {
      background: rgba(0, 179, 84, .7);
    }

    .timestamp {
      font-size: 12px;
      color: #ccc;
      margin-top: 4px;
    }

    /* ===== Users panel & list (critical) ===== */
    #users-title {
      font-size: 16px;
      font-weight: bold;
      color: #f3f4f6;
      margin: 15px 0 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #333;
    }

    #users-panel {
      display: flex;
      flex-direction: column;
      flex: 1;
      /* always expand in sidebar */
      min-height: 0;
      /* allow user-list to shrink/scroll */
    }

    #user-list {
      flex: 1;
      min-height: 0;
      /* 👈 critical fix */
      overflow-y: auto;
      /* list scrolls, not body */
      overscroll-behavior: contain;

      list-style: none;
      padding: 0;
      margin: 0;
      background: #100e09;
      border: 1px solid #333;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .5);

      scrollbar-width: thin;
      scrollbar-color: #4b5563 #1a1813;

      /* HIDE scrollbar but keep scroll */
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    #user-list::-webkit-scrollbar {
      display: none;
      /* Chrome, Safari */
    }

    #user-list li {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      font-size: 14px;
      color: #e5e7eb;
      transition: background .2s;
      border-bottom: 1px solid #222;
    }

    #user-list li:hover {
      background: #1a1813;
      cursor: default;
    }

    /* Animations */
    #user-list li.fade-in {
      animation: fadeIn .4s ease forwards;
    }

    #user-list li.fade-out {
      animation: fadeOut .3s ease forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateY(0)
      }

      to {
        opacity: 0;
        transform: translateY(-3px)
      }
    }

    #user-list::-webkit-scrollbar {
      width: 6px;
    }

    #user-list::-webkit-scrollbar-track {
      background: #1a1813;
      border-radius: 10px;
    }

    #user-list::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 10px;
      border: 1px solid #1a1813;
    }

    #user-list::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    /* Responsive mobile */
    @media (max-width:768px) {
      body {
        flex-direction: column;
        overflow: auto;
      }

      #sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #333;
        height: auto;
      }

      /* Force list height cap on mobile */
      #users-panel {
        flex: none;
        max-height: 200px;
      }

      #user-list {
        max-height: 200px;
        overflow-y: auto;
      }
    }
  </style>
</head>

<body>
  <div id="show-arrow" onclick="toggleSidebar()">»</div>

  <div id="sidebar">
    <div id="toggle-arrow" onclick="toggleSidebar()">«</div>
    <h2 style="font-size:1.2em;">💬 Realtime Chat</h2>

    <label>Your Name:</label>
    <input id="name" type="text" placeholder="e.g. Anit" />
    <label>Room ID:</label>

    <!-- Ad just above input -->
    <ins class="adsbygoogle" style="display:block; margin:15px auto;" data-ad-client="ca-pub-7006477250957433"
      data-ad-slot="7006477250957433" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

    <input id="room" type="text" placeholder="e.g. project-123" />
    <button onclick="joinRoom()" style="width:100%;">Enter</button>
    <button onclick="leaveRoom()" style="width:100%;background:#ff9800;color:white;">Leave Room</button>
    <button onclick="clearRoom()" style="width:100%;background:#f44336;color:white;">Clear Room</button>
    <button onclick="destroyRoom()" style="width:100%;background:#eb3c06;color:white;">Destroy Room</button>

    <div id="users-title">👥 Users</div>
    <div id="users-panel">
      <ul id="user-list"></ul>
    </div>
  </div>

  <!-- Intro Section -->
  <div id="intro"
    style="padding:20px; background:#100e09; color:#eaeaea; max-width:1000px; margin:auto; line-height:1.6; text-align:center;">

    <header style="background:#1a1812; padding:20px; border-bottom:1px solid #333;">
      <h1 style="color:#25d366; margin:0; text-align:center;">
        Welcome to RealTime Chat – Connect Instantly With Friends
      </h1>
    </header>

    <p>
      <strong>RealTime Chat</strong> is a fast, secure, and easy-to-use chat platform
      where you can connect with your friends, family, or team instantly.
      Whether you’re on desktop or mobile, our chat app keeps you connected anytime, anywhere.
    </p>

    <p>
      Unlike traditional messaging apps, RealTime Chat runs directly in your browser,
      with no downloads required. Just enter your name, pick a room, and start chatting instantly!
    </p>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7006477250957433"
      crossorigin="anonymous"></script>
    <!-- blog2 -->
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7006477250957433" data-ad-slot="9197511706"
      data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

    <p>
      Our mission is to make communication simple, private, and accessible to everyone.
      With RealTime Chat, you don’t need to worry about complicated sign-ups, long installation
      processes, or heavy apps that slow down your device. Everything works instantly in your
      browser, making it lightweight and efficient. Whether you’re managing a study group,
      catching up with family, or collaborating with your team, RealTime Chat is built to keep
      conversations flowing smoothly.
    </p>

    <p>
      We believe in <strong>privacy-first communication</strong>. Unlike many messaging apps that
      collect user data, RealTime Chat respects your privacy. Your chats remain secure and are
      never shared with third parties. This makes our platform a safe space for casual users,
      professionals, and communities who value private and distraction-free conversations.
    </p>

    <p>
      Our platform is also <strong>constantly evolving</strong>. We are working on adding more
      features such as media sharing, customizable chat themes, and enhanced moderation tools
      for group conversations. By choosing RealTime Chat today, you’re joining a growing
      community that values fast, private, and reliable communication.
    </p>

    <!-- Three-column layout -->
    <div
      style="display:flex; justify-content:space-between; gap:20px; margin-top:20px; text-align:left; flex-wrap:wrap;">

      <!-- Features -->
      <div style="flex:1; min-width:220px;">
        <h2 style="color:#25d366; margin:0 0 5px 0; font-size:1.3em;">✨ Features</h2>
        <ul style="list-style:none; padding-left:0; margin:0; font-size:0.95em;">
          <li>✅ Instant real-time messaging</li>
          <li>✅ Private and group chats</li>
          <li>✅ Simple and clean interface</li>
          <li>✅ Free to use</li>
        </ul>
      </div>

      <!-- Why Choose Us -->
      <div style="flex:1; min-width:220px;">
        <h2 style="color:#25d366; margin:0 0 8px 0; font-size:1.3em;">💡 Why Choose Us?</h2>
        <p style="margin:0; font-size:0.95em;">
          Unlike other chat apps, <strong>RealTime Chat</strong> doesn’t require sign-ups or downloads.
          It’s lightweight, privacy-friendly, and always available in your browser.
        </p>
      </div>

      <!-- FAQ -->
      <div style="flex:1; min-width:200px; font-size:0.867em;">
        <h2 style="color:#25d366; margin:0 0 5px 0; font-size:1.2em;">📌 FAQ</h2>
        <ul style="list-style:disc; padding-left:18px; margin:0;">
          <li><strong>Is it free?</strong> Yes, 100% free.</li>
          <li><strong>Is it safe?</strong> All chats stay private.</li>
          <li><strong>On mobile?</strong> Yes, works on all devices.</li>
          <li><strong>Need download?</strong> No, works directly in browser.</li>
        </ul>
      </div>
    </div>
    <!-- Footer Section -->
    <footer style="margin-top:30px; padding:15px; background:#1a1812; color:#aaa; 
  text-align:center; font-size:0.9em; border-top:1px solid #333; width:100%; box-sizing:border-box;">
      <div style="max-width:900px; margin:0 auto;">
        <p>
          <a href="/about.html" style="color:#25d366; text-decoration:none; margin:0 15px;">About</a> |
          <a href="/privacy-policy.html" style="color:#25d366; text-decoration:none; margin:0 15px;">Privacy
            Policy</a> |
          <a href="/terms-of-service.html" style="color:#25d366; text-decoration:none; margin:0 15px;">Terms of
            Service</a>|
          <a href="/disclaimer.html" style="color:#25d366; text-decoration:none; margin:0 15px;">Disclaimer</a>
          |
          <a href="/blog.html" style="color:#25d366; text-decoration:none; margin:0 15px;">Blog</a>
          |
          <a href="/contact.html" style="color:#25d366; text-decoration:none; margin:0 15px;">Contact</a>
        </p>
        <p style="margin-top:8px; font-size:0.8em; color:#777;">
          © 2025 RealTime Chat. All rights reserved.
        </p>
      </div>
    </footer>

  </div>

  <div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
      <input id="input" placeholder="Type your message…" disabled />
      <input type="file" id="fileInput" style="display:none" />
      <button id="attach" type="button" disabled>+</button>
      <button id="send" type="button" disabled>Send</button>
    </div>
  </div>

  <script>
    // ✅ Storage fallback (localStorage → sessionStorage → cookies)
    const Storage = {
      set(k, v) {
        try { localStorage.setItem(k, v); return; } catch { }
        try { sessionStorage.setItem(k, v); return; } catch { }
        document.cookie = `${k}=${encodeURIComponent(v)}; path=/`;
      },
      get(k) {
        try { return localStorage.getItem(k) || sessionStorage.getItem(k); } catch { }
        const m = document.cookie.match(new RegExp("(^| )" + k + "=([^;]+)"));
        return m ? decodeURIComponent(m[2]) : null;
      },
      remove(k) {
        try { localStorage.removeItem(k); } catch { }
        try { sessionStorage.removeItem(k); } catch { }
        document.cookie = `${k}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT`;
      }
    };

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(() => console.log("✅ Service Worker registered"))
          .catch(err => console.error("SW failed", err));
      });
    }
    // Helper function to convert base64 URL to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')   // Replace "-" with "+"
        .replace(/\_/g, '/');   // Replace "_" with "/"

      const rawData = atob(base64);  // Decode base64 string
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }

      return outputArray;
    }

    // VAPID public key (ensure it's base64url-encoded and correctly placed here)
    const applicationServerKey = urlBase64ToUint8Array('LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFRTd1YXNPbHBGdHgwNkt4Tnp5MVZoby9uZ21sUAphdkEwei8zMW5Gd0xWQWxkSWo3OEdFOW1BV0psQTN5ajI5VGlyYlNhYXEvdVZWYVY2ZGg3RG5IdHVRPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg');

    // Subscribe to push notifications
    async function requestNotificationPermission() {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        console.log('Notification permission granted.');

        // Get the registration for service worker
        const registration = await navigator.serviceWorker.register('/sw.js');

        // Ensure service worker is activated
        registration.addEventListener('activated', async () => {
          // Subscribe to push notifications
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: applicationServerKey, // Correct format
          });

          // Debug: Log the subscription object
          console.log('Push subscription object:', subscription);

          // Send the subscription to the backend
          const response = await fetch('/api/subscribe', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(subscription),
          });

          const result = await response.json();
          console.log('Backend response:', result.message);
        });
      } else {
        console.log('Notification permission denied.');
      }
    }

    // Trigger the notification permission request
    if ('Notification' in window && 'serviceWorker' in navigator) {
      requestNotificationPermission();
    }




    let socket, currentRoom = "", currentName = "";
    let joinedRooms = new Set();
    let lastPersistedTs = null;
    let alreadyFetchingHistory = false; // ✅ guard against multiple history loads

    function bumpTs(ts) {
      if (!ts) return;
      if (!lastPersistedTs || ts > lastPersistedTs) lastPersistedTs = ts;
    }

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const showArrow = document.getElementById("show-arrow");
      if (sidebar.classList.contains("hidden")) {
        sidebar.classList.remove("hidden");
        showArrow.style.display = "none";
      } else {
        sidebar.classList.add("hidden");
        showArrow.style.display = "block";
      }
    }

    // Hide chat by default
    document.getElementById("input-area").style.display = "none";
    document.getElementById("chat-container").style.display = "none";
    document.getElementById("messages").style.display = "none";
    document.getElementById("intro").style.display = "none"; // 🔥 hide intro by default

    function joinRoom() {
      currentName = document.getElementById("name").value.trim();
      currentRoom = document.getElementById("room").value.trim();
      if (!currentName || !currentRoom) { alert("Enter name and room first!"); return; }
      if (joinedRooms.has(currentRoom)) {
        alert(`You are already in room "${currentRoom}"!`);
        return;
      }

      // 🔥 Save with fallback
      Storage.set("chat_name", currentName);
      Storage.set("chat_room", currentRoom);

      // reset
      document.getElementById("messages").innerHTML = "";
      lastPersistedTs = null;
      alreadyFetchingHistory = false;
      document.getElementById("input").disabled = false;
      document.getElementById("send").disabled = false;
      document.getElementById("attach").disabled = false;
      document.getElementById("user-list").innerHTML = "";

      socket = io("/", { path: "/socket.io" });

      // ✅ Reliable join wrapper with retry + ACK
      function safeJoinWithRetry(attempt = 1) {
        if (!socket || !socket.connected) return;
        if (joinedRooms.has(currentRoom)) return; // ✅ avoid duplicate join

        socket.emit("join", { room: currentRoom, sender: currentName, lastTs: lastPersistedTs || null }, ack => {
          if (ack && ack.success) {
            console.log("✅ Joined room:", currentRoom);
            joinedRooms.add(currentRoom);
          } else {
            console.log("⚠️ Join failed, retrying...", attempt);
            setTimeout(() => safeJoinWithRetry(attempt + 1), 500);
          }
        });
      }

      // ✅ users_update with guard
      socket.on("users_update", data => {
        if (!currentRoom || data.room !== currentRoom) return;

        const list = document.getElementById("user-list");
        const seen = new Set();
        const existing = new Map();
        list.querySelectorAll("li").forEach(li => existing.set(li.getAttribute("data-name"), li));

        data.users.forEach(u => {
          if (seen.has(u.name)) return;
          seen.add(u.name);

          const color = u.status === "online" ? "#25d366" : "red";
          const displayName = u.name === currentName ? `${u.name} (Me)` : u.name;

          let li = existing.get(u.name);
          if (li) {
            li.innerHTML = `<span style="color:${color}">●</span> ${displayName}`;
            existing.delete(u.name);
          } else {
            li = document.createElement("li");
            li.setAttribute("data-name", u.name);
            li.className = "fade-in";
            li.innerHTML = `<span style="color:${color}">●</span> ${displayName}`;
            list.appendChild(li);
          }
        });

        existing.forEach(li => {
          li.classList.add("fade-out");
          setTimeout(() => li.remove(), 300);
        });
      });

      document.getElementById("chat-container").style.display = "flex";
      document.getElementById("input-area").style.display = "flex";
      document.getElementById("intro").style.display = "none";
      document.getElementById("messages").style.display = "block";

      socket.on("left_room", data => {
        if (data.room === currentRoom) {
          document.getElementById("user-list").innerHTML = "";
        }
      });

      socket.on("room_destroyed", (data) => {
        if (currentRoom === data.room) {
          document.getElementById("input").disabled = true;
          document.getElementById("send").disabled = true;
          document.getElementById("attach").disabled = true;
          addMessage({
            sender: "System",
            text: "Room destroyed. You cannot send messages until you join a new room.",
            ts: new Date().toISOString()
          });
          lastPersistedTs = null;
          joinedRooms.delete(data.room);
          currentRoom = "";
          document.getElementById("user-list").innerHTML = "";

          Storage.remove("chat_name");
          Storage.remove("chat_room");

          document.getElementById("chat-container").style.display = "none";
          document.getElementById("input-area").style.display = "none";
          document.getElementById("intro").style.display = "block";
          document.getElementById("messages").style.display = "none";
        }
      });

      socket.on("clear", data => {
        if (currentRoom === data.room) {
          document.getElementById("messages").innerHTML = "";
          addMessage({ sender: "System", text: data.message, ts: new Date().toISOString() });
          lastPersistedTs = null;
        }
      });

      socket.on("connect", () => {
        safeJoinWithRetry();
      });

      socket.on("message", data => addMessage(data));
      socket.on("file", data => addFileMessage(data));

      // ✅ Safe send binding
      document.getElementById("send").onclick = sendMessage;
      document.getElementById("input").onkeydown = e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      document.getElementById("attach").onclick = e => {
        e.preventDefault();
        document.getElementById("fileInput").click();
      };

      document.getElementById("fileInput").onchange = () => {
        const file = document.getElementById("fileInput").files[0];
        if (!file || !currentRoom) return;
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit("file", {
            room: currentRoom, sender: currentName,
            filename: file.name, mimetype: file.type, data: reader.result
          });
        };
        reader.readAsDataURL(file);
      };
    }

    let sending = false;

    function sendMessage() {
      if (sending) return; // prevent double send
      const inputEl = document.getElementById("input");
      const text = inputEl.value.trim();
      if (!text || !currentRoom) return;

      sending = true;
      document.getElementById("send").disabled = true;

      socket.emit("message", { room: currentRoom, sender: currentName, text }, () => {
        // ACK received
        sending = false;
        document.getElementById("send").disabled = false;
      });

      // fallback reset in case ACK doesn’t return
      setTimeout(() => {
        sending = false;
        document.getElementById("send").disabled = false;
      }, 500);

      inputEl.value = "";
    }

    function addMessage(data) {
      const messages = document.getElementById("messages");
      const last = messages.lastElementChild;

      if (data.sender === "System" && last && last.textContent === data.text) return;

      if (!currentRoom && data.sender === "System" && /joined/i.test(data.text) && data.text.includes(currentName)) {
        return;
      }

      const div = document.createElement("div");
      if (data.sender === "System") {
        div.className = "msg system";
        div.textContent = data.text;
      } else {
        bumpTs(data.ts);
        const isMe = data.sender.toLowerCase() === currentName.toLowerCase();
        div.className = "msg " + (isMe ? "me" : "other");
        div.dataset.ts = data.ts;
        div.innerHTML = `<strong>${data.sender}</strong><br>${data.text}<br><small>${new Date(data.ts).toLocaleString()}</small>`;
      }
      messages.appendChild(div);
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }

    function addFileMessage(data) {
      bumpTs(data.ts);
      const div = document.createElement("div");
      const isMe = data.sender.toLowerCase() === currentName.toLowerCase();
      div.className = "msg " + (isMe ? "me" : "other");
      div.dataset.ts = data.ts;

      if (data.mimetype && data.mimetype.startsWith("image/")) {
        div.innerHTML = `
      <div class="username"><strong>${data.sender}</strong></div>
      <div class="image-wrapper">
        <a href="${data.data}" download="${data.filename}" class="download-icon" title="Download">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 24 24">
            <path d="M12 16l4-5h-3V4h-2v7H8l4 5zM5 18h14v2H5v-2z"/>
          </svg>
        </a>
        <img src="${data.data}" alt="${data.filename}"> 
      </div>
      <div class="timestamp"><small>${new Date(data.ts).toLocaleString()}</small></div>`;
      } else {
        div.innerHTML = `
      <div class="username"><strong>${data.sender}</strong></div>
      <a href="${data.data}" download="${data.filename}" class="download-link">📎 ${data.filename}</a><br>
      <div class="timestamp"><small>${new Date(data.ts).toLocaleString()}</small></div>`;
      }
      const messages = document.getElementById("messages");
      messages.appendChild(div);
      messages.scrollTo({ top: messages.scrollHeight, behavior: 'smooth' });
    }

    async function clearRoom() {
      if (!currentRoom) { alert("Join a room first!"); return; }
      try {
        const res = await fetch(`/clear/${encodeURIComponent(currentRoom)}`, {
          method: "DELETE",
          cache: "no-store"
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Failed to clear room: ${res.status} ${text}`);
        }
      } catch (err) {
        console.error(err);
        alert(err.message);
      }
    }

    async function destroyRoom() {
      if (!currentRoom) { alert("Join a room first!"); return; }
      if (!confirm(`Are you sure you want to destroy room "${currentRoom}"?`)) return;

      await fetch(`/destroy/${currentRoom}`, { method: "DELETE" });
      document.getElementById("messages").innerHTML = "";
      addMessage({ sender: "System", text: "Room destroyed. All messages cleared. You cannot send messages until you join a new room.", ts: new Date().toISOString() });

      lastPersistedTs = null;
      Storage.remove("chat_name");
      Storage.remove("chat_room");

      joinedRooms.delete(currentRoom);
      currentRoom = "";

      document.getElementById("user-list").innerHTML = "";
      document.getElementById("chat-container").style.display = "none";
      document.getElementById("input-area").style.display = "none";
      document.getElementById("intro").style.display = "block";
      document.getElementById("messages").style.display = "none";
    }

    function leaveRoom() {
      if (!currentRoom) { alert("You are not in a room!"); return; }
      const leftRoom = currentRoom; // keep old room for message
      socket.emit("leave", { room: currentRoom, sender: currentName });

      document.getElementById("input").disabled = true;
      document.getElementById("send").disabled = true;
      document.getElementById("attach").disabled = true;

      // ✅ Proper leave message
      addMessage({ sender: "System", text: `YOU LEFT FROM ROOM ${leftRoom}`, ts: new Date().toISOString() });

      lastPersistedTs = null;
      joinedRooms.delete(currentRoom);
      currentRoom = "";

      Storage.remove("chat_name");
      Storage.remove("chat_room");

      document.getElementById("user-list").innerHTML = "";
      document.getElementById("chat-container").style.display = "block";
      document.getElementById("input-area").style.display = "none";
      document.getElementById("messages").style.display = "block";
    }

    window.addEventListener("offline", () => {
      if (socket && socket.connected) {
        socket.disconnect();
      }
    });

    let reconnectTimer;
    window.addEventListener("online", () => {
      clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(() => {
        if (socket && !socket.connected && currentRoom && currentName) {
          socket.connect();
          socket.emit("join", { room: currentRoom, sender: currentName, lastTs: lastPersistedTs || null });
        }
      }, 300);
    });

    // 🔹 Auto-restore join
    window.addEventListener("load", () => {
      const savedName = Storage.get("chat_name");
      const savedRoom = Storage.get("chat_room");
      if (savedName && savedRoom) {
        document.getElementById("name").value = savedName;
        document.getElementById("room").value = savedRoom;
        setTimeout(() => joinRoom(), 600);
      } else {
        document.getElementById("intro").style.display = "block";
      }
    });
  </script>





</body>

</html>
